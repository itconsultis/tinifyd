#!/usr/bin/env bash

set -aeu -o pipefail

if [ ! -f ./src/.env ]; then
    cp ./src/.env.example ./src/.env
    echo "Created boilerplate .env file in src directory.\n"
    echo "********************************************************"
    echo "*** IMPORTANT: You need to modify the .env file NOW. ***"
    echo "*** Make your modifications, then re-run this script.   "
    echo "********************************************************"
    exit 0    
fi

source ./src/.env

NODE_CONTAINER=${PROJECT}_node
DB_CONTAINER=${PROJECT}_db
STORAGE_CONTAINER=${PROJECT}_storage

# wait for mysql server to start accepting queries
wait_for_mysql () {
    echo "Waiting for MySQL server to start accepting queries..."
    while [ 0 ];
    do
        cmd="mysql -u root -p${TINIFYD_DB_PASS} -e 'SELECT \"READY\"'"
        result=$(docker exec -ti tinifyd_db bash -c "$cmd" || true)
        sleep 2

        if [[ "$result" =~ "READY" ]]; then
            break
        fi
    done
}



run_migrations () {
    echo "Running migrations..."
    docker exec $NODE_CONTAINER bash -c "cd src && bin/migrate up"
}


start_process () {
    echo "Starting PM2 process manager"
    docker exec $NODE_CONTAINER bash -c "cd src && bin/pm2 start index.js"
}


containers_up () {
    echo "Generating docker-compose.yml"
    echo -e "# This file is auto-generated by the start script.\n---\n" > docker-compose.yml
    envsubst < docker-compose-template.yml >> docker-compose.yml
    docker-compose -f docker-compose.yml -p $PROJECT up -d
}


containers_up
wait_for_mysql
run_migrations
start_process

